#!/usr/bin/env sh
set -o errexit
set -o pipefail
set -o nounset

pango_label() {
  printf "<span weight=\"light\" style=\"italic\">&lt;$1&gt;</span>"
}

pango_makemodel() {
  printf "<span weight=\"light\" style=\"italic\">($1)</span>"
}

mounting_info() {
  # $1 = /dev/x
  partinfo=$(udisksctl info -b "$1")
  mounted=$(printf "$partinfo" | grep MountPoints: | awk '{print $2}' || echo -n "missing")
  label=$(printf "$partinfo" | grep IdLabel: | awk '{print $2}')
  if [ "$mounted" = "missing" ]; then
    return
  elif [ -n "$mounted" ]; then
    out="$1 [$mounted]"
  else
    out="$1"
  fi
  if [ -n "$label" ]; then
    out="$out $(pango_label "$label")"
  fi
  printf "$out $(pango_makemodel "${vendor%"${vendor##*[![:space:]]}"} ${model%"${model##*[![:space:]]}"}")"
}

devices=""
for device in /sys/block/*; do
  info=$(udevadm info --query property --path $device)
  if [ -n "$(printf "$info" | grep ^ID_BUS=usb)" ]; then
    devname="$(printf "$info" | grep ^DEVNAME= | cut -b 9-)"
    model="$(printf "$info" | grep ^ID_MODEL_ENC= | cut -b 14-)"
    vendor="$(printf "$info" | grep ^ID_VENDOR_ENC= | cut -b 15-)"
    if [ ! -b ${devname}1 ]; then
      info=$(mounting_info $devname)
      if [ -n "$info" ]; then
        devices="$devices\n$info"
      else
        echo "no mountpoint info available for device $devname"
      fi
    else
      for part in ${devname}[0-9]*
      do
        info=$(mounting_info $part)
        if [ -n "$info" ]; then
          devices="$devices\n$info"
        else
          echo "no mountpoint info available for partition $part"
        fi
      done
    fi
  fi
done

n=$(printf "${devices}" | wc -l)
choice="$(printf "${devices:2}" | rofi -dmenu -i -l $n -matching fuzzy -markup-rows -format p -p 'USB device')"

dev="$(printf "$choice"|awk '{print $1}')"
mountpoint="$([[ "$choice" =~ \[[^]]*\] ]] && printf "${BASH_REMATCH[0]#/#}" || printf "")"
label="$([[ "$choice" =~ \<([^\>]*)\> ]] && printf "${BASH_REMATCH[1]#/#}" || printf "")"
mm="$([[ "$choice" =~ \(([^\)]*)\) ]] && printf "${BASH_REMATCH[1]#/#}" || printf "")"

if [ -n "$mountpoint" ]; then
  msg="└─ $mountpoint"
  if [ -n "$label" ]; then
    msg="$msg $(pango_label "$label")"
  fi
  msg="$msg $(pango_makemodel "$mm")"

  case "$(printf "Open\nUnmount"|rofi -dmenu -i -l 2 -matching fuzzy -p "$dev" -mesg "$msg")" in
    Unmount)
      out=$(udisksctl unmount -b "$dev")
      notify-send -i "media-flash" -a "USB mounter" "$out"
      ;;
    Open) konsole -e yazi "${mountpoint:1:-1}" ;;
    *) exit 1 ;;
  esac
else
  msg="└─"
  if [ -n "$label" ]; then
    msg="$msg $(pango_label "$label")"
  fi
  msg="$msg $(pango_makemodel "$mm")"

  case "$(printf "Mount"|rofi -dmenu -i -l 1 -matching fuzzy -p "$dev" -mesg "$msg")" in
    Mount)
      out=$(udisksctl mount -b "$dev")
      notify-send -i "media-flash" -a "USB mounter" "$out"
      ;;
    *) exit 1 ;;
  esac
fi
